---
params:
  country: "Thailand"
title: "EIDITH Data Cleaning Report: `r params$country`"
author: "EcoHealth Alliance"
date: "`r Sys.Date()`"
output:
  html_document:
    keep_md: true
---

```{r setup, include = FALSE}

knitr::opts_chunk$set(echo = FALSE)
library(tidyverse)
library(openxlsx)
library(leaflet) 
library(knitr)
library(kableExtra)
h <- here::here
walk(list.files(h("R/"), full.names = TRUE),
     source, echo = FALSE, verbose = FALSE)
country <- params$country

```

Event Table
```{r event, message = FALSE, warning = FALSE}

event <- read_tsv(h("raw-eidith-data", "Event.tsv.gz")) %>%
  filter(Country == country)

# map locations
leaflet(data = event) %>%
  addTiles() %>%
  addMarkers(lng = ~EventLongitude, lat = ~EventLatitude, label = ~SiteName)

# unique character values table
event_char <- event %>% select_if(is.character) %>% select(-EventName, -SiteName)
event_char_uniq <- apply(event_char, 2, unique)
map_df(event_char_uniq, ~paste(.x, collapse = "; ")) %>%
  mutate(EventDate = paste0("min = ", min(event$EventDate), "; max = ", max(event$EventDate))) %>%
  select(Country, EventDate, everything()) %>%
  t() %>%
  kable() %>%
  kable_styling()

# skimr summary
#event %>% skimr::skim() %>% skimr::kable()

# check for NAs
na_index <- get_na(event, ignore_notes = TRUE)

# check for solo chars
solo_index <- get_solo_char(event)

# check for numeric outliers (not including lat/long)
outlier_index <- get_outlier(event)

# check that EventName matches SiteName and EventDate
event_index <- get_event_mismatch(event)

### for excel output
highlight_cells <- bind_rows(na_index,
                             solo_index, 
                             outlier_index,
                             event_index)

```

```{r animal, message = FALSE}

# animal <- read_tsv(h("raw-eidith-data", "Animal.tsv.gz")) %>%
#   filter(Country == country)
# 
# # Run a check and summarize results
# 
# knitr::kable(count(animal, SpeciesScientificName))

```

```{r}

# Use unique IDs to generate excel spreadsheets from raw data (eidith::ed2_get()),
# use openxlsx (writeData, conditionalFormatting) to write and color rows of interest

```

```{r write-xlsx-table, include = FALSE}


# Get highlighted workbook object

wb <- get_highlighted_wb(
  dfs = list(event),
  tab.names = c("Event"),
  markup.dfs = list(highlight_cells)
)


# Write the xlsx workbook for the country in question

saveWorkbook(
  wb,
  file = h("outputs", paste0(country, "-eidith-cleaning-workbook.xlsx")),
  overwrite = TRUE
)

```
