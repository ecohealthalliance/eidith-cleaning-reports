---
params:
  country: "Thailand"
title: "EIDITH Data Cleaning Report: `r params$country`"
author: "EcoHealth Alliance"
date: "`r Sys.Date()`"
output:
  html_document:
    keep_md: true
---

```{r setup, include = FALSE, message = FALSE, warning = FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)
library(tidyverse)
library(lubridate)
library(openxlsx)
library(leaflet) 
library(knitr)
library(kableExtra)
h <- here::here
walk(list.files(h("R/"), full.names = TRUE),
     source, echo = FALSE, verbose = FALSE)
country <- params$country

```
This report and accompanying Excel workbook are intended to provide data cleaning support to country teams.  Please review both documents to catch any potential errors in your data.

**Excel workbook**  
EIDITH tables are shown on separate sheets in each workbook.  Cells requiring review within each table are highlighted, and the basis of the highlight is provided in the first column of each table (“cleaning_flags”).  The following potential issues are flagged:   

•	NAs (*to add: which columns are included in this check?*)  
•	Unique character responses (i.e., the only case of a given response in the field).  
•	Numeric outliers, defined as greater than the 75th percentile + 2.5 * inter-quartile range or less than the 25th percentile - 2.5 * IQR.  
•	Duplicate EventName, AnimalID, or SpecimenID.  
•	In the Event table, mismatches between EventName, which is “SiteName-EventDate”, and the SiteName or EventDate fields.  
•	In the Specimen table, mismatches SpecimenID, which is “Animal/HumanID.SpecimenTypeMedium”, and Animal/Human ID, SpecimenType, and/or Medium fields.  Note that SpecimenID cells may be highlighted if the SpecimenTypeMedium abbreviations are not recognized in EIDITH ID protocols.

Note that tables are excluded from the workbook if no cells are found to be a potential issue.  

**Report**  
•	The map below should be used confirm the correct placement of site locations (mouseover points to see site names).  
•	The table summaries below the map should be used to confirm values and counts of missing responses within each field.  For numeric and date fields, the range of values is shown.  For character fields, each unique value is provided with response counts in parenthesis.  Note that for fields with multiple possible responses (e.g., “DiseaseTransmissionInterfaces”), counts represent the total number of times each response is given.  The following are excluded from these summary tables: latitude/longitude, notes/comments, event name, site name, and ID fields.  The animal table also excludes any fields related to species type, as these will be reviewed separately.  


```{r event}
event <- read_tsv(h("raw-eidith-data", paste0("Event-", country, ".tsv.gz")),  col_types = event_specs)

## for excel-------

# check for NAs
na_index <- get_na(event, cols_to_ignore = c("Notes"))

# check for solo chars
solo_index <- get_solo_char(event)

# check for numeric outliers (not including lat/long)
outlier_index <- get_outlier(event)

# check that EventName matches SiteName and EventDate
event_index <- get_event_mismatch(event)

# check ID dups 
dup_id_index <- get_dups(event, "EventName")

# for excel output
event.markup <- bind_rows(na_index,
                          solo_index, 
                          outlier_index,
                          event_index,
                          dup_id_index)
```

```{r event-site-map}
# map site locations 
leaflet(data = event) %>%
  addTiles() %>%
  addAwesomeMarkers(lng = ~SiteLongitude, lat = ~SiteLatitude, 
                    label = get_event_labels(),
                    icon = get_event_icons()
  )

```

<details>
<summary>Event Summary</summary>
```{r event-unique}
create_unique_table(event, cols_to_ignore = c("EventName", "SiteName", "Notes"))

```
</details>

```{r animal}

animal <- read_tsv(h("raw-eidith-data",  paste0("Animal-", country, ".tsv.gz")), col_types = animal_specs) 

## for excel-------

# check for NAs
na_index <- get_na(animal, cols_to_ignore = c("Notes", "Comment", "Bat", "NHP", "Rodent", "Taxa|Class|Order|Family|Genus|Species"))

# check for solo chars
solo_index <- get_solo_char(animal)

# check for numeric outliers (not including lat/long)
outlier_index <- get_outlier(animal)

# check ID dups 
dup_id_index <- get_dups(animal, "AnimalID")

# for excel output
animal.markup <- bind_rows(
  #na_index, 
  solo_index,
  outlier_index,
  dup_id_index)

```

<details>
<summary>Animal Summary</summary>
```{r animal-unique}
# unique character values table
create_unique_table(animal,
                    cols_to_ignore = c("Notes", "SiteName", "AnimalID", "EventName", "Taxa|Class|Order|Family|Genus|Species"))
```
</details>

```{r specimen}

specimen <- read_tsv(h("raw-eidith-data", paste0("Specimen-", country, ".tsv.gz")), col_types = specimen_specs)

## for excel-------

# check for NAs
na_index <- get_na(specimen, cols_to_ignore = c("Notes", "Comment", "humans only"))

# check for solo chars
solo_index <- get_solo_char(specimen)

# check for numeric outliers (not including lat/long)
outlier_index <- get_outlier(specimen)

# check that EventName matches SiteName and EventDate
specimen_index <- get_specimen_mismatch(specimen)

# check ID dups 
dup_id_index <- get_dups(specimen, "SpecimenID")

# for excel output
specimen.markup <- bind_rows(
  #na_index, 
  solo_index,
  outlier_index,
  specimen_index,
  dup_id_index
  )

```

<details>
<summary>Specimen Summary</summary>
```{r specimen-unique}
# unique character values table
create_unique_table(specimen,
                    cols_to_ignore = c("Notes", "SiteName", "ID", "EventName", "Taxa|Class|Order|Family|Genus|Species"))
```
</details>

```{r style-xlsx-table, include = FALSE}

# Get highlighted workbook object
markup_list <- list("event" = event.markup, "animal" = animal.markup, "specimen" = specimen.markup)
markup_list <- markup_list[unlist(map(markup_list, ~nrow(.x)>0))]

wb <- get_highlighted_wb(
  dfs = sapply(names(markup_list), get),
  tab.names = names(markup_list),
  markup.dfs = markup_list
)

```

```{r write-xlsx-table, include = FALSE}
# Write the xlsx workbook for the country in question
saveWorkbook(
  wb,
  file = h("outputs", paste0(country, "-eidith-cleaning-workbook.xlsx")),
  overwrite = TRUE
)
```
