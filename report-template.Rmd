---
params:
  country: "Thailand"
title: "EIDITH Data Cleaning Report: `r params$country`"
author: "EcoHealth Alliance"
date: "`r Sys.Date()`"
output:
  html_document:
    keep_md: true
---

```{r setup, include = FALSE, message = FALSE, warning = FALSE}
knitr::opts_chunk$set(echo = FALSE)
library(tidyverse)
library(lubridate)
library(openxlsx)
library(leaflet) 
library(knitr)
library(kableExtra)
h <- here::here
walk(list.files(h("R/"), full.names = TRUE),
     source, echo = FALSE, verbose = FALSE)
country <- params$country

```

## Event Table
```{r event}
event <- read_tsv(h("raw-eidith-data", "Event.tsv.gz"),  col_types = event_specs) %>%
  filter(Country == country) 

## for excel-------

# check for NAs
na_index <- get_na(event, cols_to_ignore = c("Notes"))

# check for solo chars
solo_index <- get_solo_char(event)

# check for numeric outliers (not including lat/long)
outlier_index <- get_outlier(event)

# check that EventName matches SiteName and EventDate
event_index <- get_event_mismatch(event)

# check ID dups 
dup_id_index <- get_dups(event, "EventName")

# for excel output
event.markup <- bind_rows(na_index,
                          solo_index, 
                          outlier_index,
                          event_index,
                          dup_id_index)
```

Site Locations
```{r event-site-map}
# map site locations 
leaflet(data = event) %>%
  addTiles() %>%
  addMarkers(lng = ~SiteLongitude, lat = ~SiteLatitude, label = ~SiteName)

```

<details>
<summary>Unique Value Check</summary>
```{r event-unique}
create_unique_table(event, cols_to_ignore = c("EventName", "SiteName", "Notes"))

```
</details>

## Animal Table
```{r animal}

animal <- read_tsv(h("raw-eidith-data", "Animal.tsv.gz"), col_types = animal_specs) %>%
  filter(Country == country)

## for excel-------

# check for NAs
na_index <- get_na(animal, cols_to_ignore = c("Notes", "Comment", "Bat", "NHP", "Rodent", "Taxa|Class|Order|Family|Genus|Species"))

# check for solo chars
solo_index <- get_solo_char(animal)

# check for numeric outliers (not including lat/long)
outlier_index <- get_outlier(animal)

# check ID dups 
dup_id_index <- get_dups(animal, "AnimalID")

# for excel output
animal.markup <- bind_rows(
  #na_index, 
  solo_index,
  outlier_index,
  dup_id_index)

```

<details>
<summary>Unique Value Check</summary>
```{r animal-unique}
# unique character values table
create_unique_table(animal,
                    cols_to_ignore = c("Notes", "SiteName", "AnimalID", "EventName", "Taxa|Class|Order|Family|Genus|Species"))
```
</details>

## Specimen Table
```{r specimen}

specimen <- read_tsv(h("raw-eidith-data", "Specimen.tsv.gz"), col_types = specimen_specs) %>%
  filter(Country == country) 

## for excel-------

# check for NAs
na_index <- get_na(specimen, cols_to_ignore = c("Notes", "Comment", "humans only"))

# check for solo chars
solo_index <- get_solo_char(specimen)

# check for numeric outliers (not including lat/long)
outlier_index <- get_outlier(specimen)

# check that EventName matches SiteName and EventDate
specimen_index <- get_specimen_mismatch(specimen)

# check ID dups 
dup_id_index <- get_dups(specimen, "SpecimenID")

# for excel output
specimen.markup <- bind_rows(
  #na_index, 
  solo_index,
  outlier_index,
  specimen_index,
  dup_id_index
  )

```

<details>
<summary>Unique Value Check</summary>
```{r specimen-unique}
# unique character values table
create_unique_table(specimen,
                    cols_to_ignore = c("Notes", "SiteName", "ID", "EventName", "Taxa|Class|Order|Family|Genus|Species"))
```
</details>

```{r style-xlsx-table, include = FALSE}

# Get highlighted workbook object
markup_list <- list("event" = event.markup, "animal" = animal.markup, "specimen" = specimen.markup)
markup_list <- markup_list[unlist(map(markup_list, ~nrow(.x)>0))]

wb <- get_highlighted_wb(
  dfs = sapply(names(markup_list), get),
  tab.names = names(markup_list),
  markup.dfs = markup_list
)

```

```{r write-xlsx-table, include = FALSE}

# Write the xlsx workbook for the country in question
saveWorkbook(
  wb,
  file = h("outputs", paste0(country, "-eidith-cleaning-workbook.xlsx")),
  overwrite = TRUE
)

```
