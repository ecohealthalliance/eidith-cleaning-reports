---
params:
  country: "Thailand"
title: 'EIDITH <span style="color:red;">DRAFT</span> Data Cleaning Report: `r params$country`'
author: "EcoHealth Alliance"
date: "`r Sys.Date()`"
output:
  html_document:
    keep_md: false
---

```{r setup, include = FALSE, message = FALSE, warning = FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)
library(tidyverse)
library(lubridate)
library(openxlsx)
library(leaflet) 
library(knitr)
library(kableExtra)
library(stringi)
h <- here::here
walk(list.files(h("R/"), full.names = TRUE),
     source, echo = FALSE, verbose = FALSE)
country <- params$country

```

<small>_Click on the_ ▶ _︎arrows to expand sections._</small>

<details>
<summary>Instructions - Read first!</summary>
**How to use these reports?**

Here are a few guidelines for using these reports to begin the data
cleaning process. These reports were compiled automatically and may help
identify data that are incorrect or require review. Please be aware data
must still be checked manually by a person familiar with the data who
can identify mistakes and make corrections.

Currently, the following tables are summarized: *Event, Animal, and
Specimen*. Human and module data are to be added. For each of the
existing tables, you may check your data through two mechanisms: the
summary in the html report and the associated tab in the Excel file.

**Html report:**

*Site Locations*: All of the sites your team has sampled are marked on
the map, color coded by concurrent sites (mouseover points to see site
names and concurrent site names). All of the independent sites are gray.
This map should be used to confirm the correct placement of all site
locations. For example, if you see a blue point that is far away from
the other blue points, you will need to check whether the GPS points are
accurate or if the concurrent site is mislabeled.

*Site Names*: Check all individual site names to confirm the spellings
are correct.

*Summary Tables:*

-   *Field*: refers to each column in the EIDITH table. The following
    columns are not summarized in these tables: latitude/longitude,
    notes/comments, event name, and ID fields.

-   *Values*: a summary of values that were entered into EIDITH

    -   **Character fields** (e.g. Season) contain the unique text along
        with the number of times each value was given.

        -   Please confirm the **spelling** is correct and check
            **whether any fields should be combined**. For example. if
            you have the following interfaces: in house (1); IN HUMAN
            DWELLING (43); in human dwelling (108), you know that the
            correct interface is: “in human dwelling” (you can confirm
            that on the EIDITH data entry app), so the other interfaces
            need to be corrected. Note, if you collected data during
            Year 1 or before the app was fully developed, you will have
            more corrections to make.

        -   Keep an eye out for **values that were only entered a few
            times**. For example, if you have the following for
            drinkingWaterShared: no (154); unknown (8); yes (2), you may
            want to confirm that there were two events/sites that truly
            have shared drinking water, or whether that was a mistake
            and all of them should be no/unknown.

    -   **Numeric and Date fields** (e.g. DurationDays) contain the
        entire range for all values in that column (e.g. 2-27).

        -   You are the best person to judge if that **range is
            reasonable** for your sites/animals. For example, if in your
            country/at your sites the only bats in the area are from two
            species of large fruit bats (say the typical arm length for
            both species is 140-160mm), and the range of the arm length
            on the html table is 21-160mm, then you should compare the
            EIDITH value of 21mm with your field data sheet to confirm
            the correct length that was measured.   
  
    -   **“All empty”** is written if a column has no values entered.
        Please **confirm that it makes sense that you didn’t enter data
        for that column**. For example, if you never had a sick animal
        that you sampled, then it might make sense that the column for
        “ClinicalSignsOther” is all empty. Whereas a column like
        Country should never be all empty.

-   *Count\_empty:* this is the number of rows that do not have a
    value for that column. In general, you will want to double check the
    columns that have empty values to confirm whether you need to make
    corrections. Counts with zeros in the numerator indicate no empty
    values.

    -   Sometimes it makes sense that you have mostly empty data. For
        example:

        -   If it says 165/165, then the values column will corroborate
            that and say “all empty”.

        -   If you only responded to one outbreak, count\_empty might
            be 160/165, which means that only 5 outbreak events were
            noted, which probably makes sense.

    -   In other cases, empty values point to an error. For example,
        if you have 2/165 empty from the Season column, you will need
        to make corrections for those 2 rows that are empty their
        Season.

**Excel file report:**

All of your data is listed in the Excel sheet (event, animal, specimens
etc are all separated by tabs). Please dig into these spreadsheets
beyond the checks below so you can get a good feel for the data and
**identify any issues that the automated check couldn’t find**. Also,
note that the automated check cannot determine whether a flag is
something that is correct or not, it can only indicate information that
you might want to double check.

There is a new column at the start of the
sheet called cleaning\_flags. This cell will have text in it and be
colored if the program identified something that needs to be checked in
that row. The text of the cleaning\_flags column will indicate what
issue needs to be checked and the column name (and column letter) that
needs to be checked in that row – be sure to check if the text is
wrapped by hitting the down arrow in the corner of the function bar (see
below) so you don’t miss any data to check.  
![](./media/image1.png){width="4in"
height="1.3in"}

In addition to noting the issues in the cleaning\_flags column, cells
with values that need to be checked are colored:

-   Bright green means it is a unique value.

    -   On the event table, values are highlighted if they are unique
        within the *entire* table. On all other tables, values are
        highlighted if they are unique for the given *site name. *

    -   A unique value may be fine (e.g., an independent site that was
        only visited one time at the start of PREDICT 2), or it could
        indicate a mistake (e.g. in Season if it is spelled “Dri”
        instead of “Dry”).

        -   While the system will pick up these misspellings, if you
            spell it wrong multiple times it won’t show up as an issue
            in the Excel file – though you should see it in the list of
            unique values on the html file.

-   Gray means no value was entered in that row (it is empty):

    -   Please check to confirm whether you have data for that row to
        update EIDITH.

    -   Note, that if all of the cells are empty data, it is not
        highlighted here, but you can see that on the html sheet (where
        it will say all empty).

-   The whole row is light green:

    -   This means that there were notes given for this entry. **Always
        check all notes**, in case you noted that something was recorded
        incorrectly and needs to be changed.

-   Purple means there is a duplicate value for something that should be
    unique (i.e., EventName, Animal\_ID, Specimen\_ID, ParticipantID)

-   Orange means that the event name does not match the site name and
    date or that the specimen name does not match the indicated sample
    type or medium (based on the original definitions at the launch of
    the EIDITH App). If you were collecting samples before the naming
    became standardized, you will notice many issues.

    -   Please confirm with the field data that the specimen type and
        medium are correct in EIDITH.

    -   **DO NOT change specimen IDs to match the EIDITH format IF THE
        TUBE STILL HAS THE ORIGINAL ID!** In this case, we will leave
        the ID as it was given originally in order to be able to match
        the samples with the metadata. If you note that the ID entered
        into EIDITH is actually incorrect from what is written on the
        tube in your freezers, then you can change it.

-   Yellow means that the value is a numeric outlier, defined as greater
    than the 75th percentile + 2.5 \* inter-quartile range (IQR) or less
    than the 25th percentile - 2.5 \* IQR.

-   To facilitate the cleaning please make use of the filter buttons

    -   You can filter the cleaning\_flag column to remove the blanks
        and see all of the rows with values that need to be checked

    -   You can also filter each of the columns by color, so if you just
        want to see the unique values, you can filter by bright green

**Making and submitting corrections:**

If you need to make a correction, you can edit the provided Excel sheet
using the following steps. See the example image below.

1.  In Excel, insert a column to the right of the data that needs to be
    changed and give it the heading "change to:". Change the heading
    text to red.

2.  Leave the original data as it is and enter what you want the data
    changed to in the newly inserted column. Highlight the new values in
    red also.

3.  If updating data that contains multiple values, in the "change to:"
    column enter the values as they should appear once the updates are
    complete. For example, if the Insect Vectors column currently shows
    "mosquito; tick" and you want to add sand fly, enter "mosquito; sand
    fly; tick" in the newly inserted column.

4.  Do the same for every column of data that needs changing.

5.  Do NOT delete any columns in the extracts.

6.  Save the file it as an .xls file to retain the formatting.

7.  Send the file to <technology@eidith.org> and CC your country liason
    and <rostal@ecohealthalliance.org>. Indicate in the email which
    sheets have changes.

![](./media/image3.png){width="4.5in"
height="3.8in"}  

</details>
```{r event}
event <- read_tsv(h("raw-eidith-data", paste0("Event-", country, ".tsv.gz")),  col_types = event_specs)

## for excel-------

# check for NAs
na_index <- get_empty(event, cols_to_ignore = c("Notes"))

# check for solo chars
solo_index <- get_solo_char(event, by_SiteName = FALSE)

# check for numeric outliers (not including lat/long)
outlier_index <- get_outlier(event)

# check that EventName matches SiteName and EventDate
event_index <- get_event_mismatch(event)

# check ID dups 
dup_id_index <- get_dups(event, "EventName")

# for excel output
event.markup <- bind_rows(na_index,
                          solo_index, 
                          outlier_index,
                          event_index,
                          dup_id_index)
```

```{r event-site-map}
# map site locations 
leaflet(data = event) %>%
  addTiles() %>%
  addAwesomeMarkers(lng = ~SiteLongitude, lat = ~SiteLatitude, 
                    label = get_event_labels(),
                    icon = get_event_icons()
  )

```
<details>
<summary>Site Names</summary>
```{r site-names}
event %>% 
  group_by(SiteName) %>%
  count() %>%
  ungroup() %>%
  mutate(SiteName = stri_join(SiteName, " (", n, ")")) %>%
  select(-n) %>%
  kable(format = "html", escape = FALSE) %>%
  kable_styling()

```

</details>

<details>
<summary>Event Summary</summary>
```{r event-unique}
create_unique_table(event, cols_to_ignore = c("EventName", "SiteName", "Notes", "Comment"))

```
</details>

```{r animal}

animal <- read_tsv(h("raw-eidith-data",  paste0("Animal-", country, ".tsv.gz")), col_types = animal_specs) 

## for excel-------

# check for NAs
na_index <- get_empty(animal, cols_to_ignore = c("Notes", "Comment", "Taxa|Class|Order|Family|Genus|Species"))

# check for solo chars
solo_index <- get_solo_char(animal, by_SiteName = TRUE)

# check for numeric outliers (not including lat/long)
outlier_index <- get_outlier(animal)

# check ID dups 
dup_id_index <- get_dups(animal, "AnimalID")

# for excel output
animal.markup <- bind_rows(
  na_index, 
  solo_index,
  outlier_index,
  dup_id_index)

```

<details>
<summary>Animal Summary</summary>
```{r animal-unique}
# unique character values table
create_unique_table(animal,
                    cols_to_ignore = c("Notes", "Comment", "SiteName", "AnimalID", "EventName", "Taxa|Class|Order|Family|Genus|Species"))
```
</details>

```{r specimen}

specimen <- read_tsv(h("raw-eidith-data", paste0("Specimen-", country, ".tsv.gz")), col_types = specimen_specs)

## for excel-------

# check for NAs
na_index <- get_empty(specimen, cols_to_ignore = c("Notes", "Comment", "humans only"))

# check for solo chars
solo_index <- get_solo_char(specimen, by_SiteName = TRUE)

# check for numeric outliers (not including lat/long)
outlier_index <- get_outlier(specimen)

# check that EventName matches SiteName and EventDate
specimen_index <- get_specimen_mismatch(specimen)

# check ID dups 
dup_id_index <- get_dups(specimen, "SpecimenID")

# for excel output
specimen.markup <- bind_rows(
  na_index, 
  solo_index,
  outlier_index,
  specimen_index,
  dup_id_index
)

```

<details>
<summary>Specimen Summary</summary>
```{r specimen-unique}
# unique character values table
create_unique_table(specimen,
                    cols_to_ignore = c("Notes", "Comment", "SiteName", "ID", "EventName", "Taxa|Class|Order|Family|Genus|Species"))
```
</details>

```{r human}

human <- read_tsv(h("raw-eidith-data", paste0("Human-", country, ".tsv.gz")), col_types = specimen_specs)

## for excel-------

# check for NAs
na_index <- get_empty(human, cols_to_ignore = c("Notes", "Comment"))

# check for solo chars
solo_index <- get_solo_char(human, by_SiteName = TRUE)

# check for numeric outliers (not including lat/long)
outlier_index <- get_outlier(human)

# check ID dups 
dup_id_index <- get_dups(human, "Q1 ParticipantID")

# for excel output
human.markup <- bind_rows(
  na_index, 
  solo_index,
  outlier_index,
  dup_id_index
)

```

<details>
<summary>Human Summary</summary>
```{r human-unique}
# unique character values table
create_unique_table(human,
                    cols_to_ignore = c("Notes", "Comment", "SiteName", "EventName", "ParticipantID"))
```
</details>

```{r style-xlsx-table, include = FALSE}

# Get highlighted workbook object
markup_list <- list("event" = event.markup, 
                    "animal" = animal.markup, 
                    "specimen" = specimen.markup,
                    "human" = human.markup
)

wb <- get_highlighted_wb(
  dfs = sapply(names(markup_list), get),
  tab.names = names(markup_list),
  markup.dfs = markup_list
)

```

```{r write-xlsx-table, include = FALSE}
# Write the xlsx workbook for the country in question
saveWorkbook(
  wb,
  file = h("outputs", paste0(country, "-eidith-cleaning-workbook.xlsx")),
  overwrite = TRUE
)
```
