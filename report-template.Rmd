---
params:
  country: "Thailand"
title: "EIDITH Data Cleaning Report: `r params$country`"
author: "EcoHealth Alliance"
date: "`r Sys.Date()`"
output:
  html_document:
    keep_md: true
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = FALSE)
library(tidyverse)
library(openxlsx)
library(leaflet) 
library(knitr)
library(kableExtra)
h <- here::here
walk(list.files(h("R/"), full.names = TRUE),
     source, echo = FALSE, verbose = FALSE)
country <- params$country

```

## Event Table
```{r event, message = FALSE, warning = FALSE}
event <- read_tsv(h("raw-eidith-data", "Event.tsv.gz"),  col_types = event_specs) %>%
  filter(Country == country) 

## for excel-------

# check for NAs
na_index <- get_na(event, cols_to_ignore = c("Notes"))

# check for solo chars
solo_index <- get_solo_char(event)

# check for numeric outliers (not including lat/long)
outlier_index <- get_outlier(event)

# check that EventName matches SiteName and EventDate
event_index <- get_event_mismatch(event)

# check ID dups 
dup_id_index <- get_dups(event, "EventName")

# for excel output
event.markup <- bind_rows(na_index,
                          solo_index, 
                          outlier_index,
                          event_index,
                          dup_id_index)
```

```{r event-map, message = FALSE, warning = FALSE}
# map site locations 
leaflet(data = event) %>%
  addTiles() %>%
  addMarkers(lng = ~SiteLongitude, lat = ~SiteLatitude, label = ~SiteName)

```

<details>
<summary>Unique Value Check</summary>
```{r event-unique, message = FALSE, warning = FALSE}
# unique character values table
create_unique_table(event,
                    cols_to_ignore = c("EventName", "SiteName", "Notes"),
                    date_col = "EventDate")

```
</details>

## Animal Table
```{r animal, message = FALSE, warning = FALSE}

animal <- read_tsv(h("raw-eidith-data", "Animal.tsv.gz"), col_types = animal_specs) %>%
  filter(Country == country)

## for excel-------

# check for NAs
na_index <- get_na(animal, cols_to_ignore = c("Notes", "Bat", "NHP", "Rodent", "Taxa|Class|Order|Family|Genus|Species"))

# check for solo chars
solo_index <- get_solo_char(animal)

# check for numeric outliers (not including lat/long)
outlier_index <- get_outlier(animal)

# check ID dups 
dup_id_index <- get_dups(animal, "AnimalID")

# for excel output
animal.markup <- bind_rows(
                           # na_index, ### too slow :(
                           solo_index,
                           outlier_index,
                           dup_id_index)

```

<details>
<summary>Animal Measurements</summary>
```{r animal-measurements, message = FALSE, warning = FALSE}
# summarize ranges
animal %>%
  select(SpeciesScientificName, matches("Bat|NHP|Rodent")) %>%
  gather(key = "Variable", value = "value", -SpeciesScientificName) %>%
  na.omit() %>%
  group_by(Variable, SpeciesScientificName) %>%
  summarize(Range = paste(min(value), max(value), sep = " - "),
            Count = n()) %>%
  kable() %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"))
```
</details>


<details>
<summary>Unique Value Check</summary>
```{r animal-unique, message = FALSE, warning = FALSE}
# unique character values table
create_unique_table(animal,
                    cols_to_ignore = c("Notes", "SiteName", "AnimalID", "EventName", "Taxa|Class|Order|Family|Genus|Species"), 
                    date_col = "SampleDate")
```
</details>

```{r write-xlsx-table, include = FALSE}

# Get highlighted workbook object
wb <- get_highlighted_wb(
  dfs = list(event, animal),
  tab.names = c("Event", "Animal"),
  markup.dfs = list(event.markup, animal.markup)
)

# Write the xlsx workbook for the country in question
saveWorkbook(
  wb,
  file = h("outputs", paste0(country, "-eidith-cleaning-workbook.xlsx")),
  overwrite = TRUE
)

```
