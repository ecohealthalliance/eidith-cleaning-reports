---
params:
  country: "Thailand"
title: "EIDITH Data Cleaning Report: `r params$country`"
author: "EcoHealth Alliance"
date: "`r Sys.Date()`"
output:
  html_document:
    keep_md: true
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = FALSE)
library(tidyverse)
library(openxlsx)
library(leaflet) 
library(knitr)
library(kableExtra)
h <- here::here
walk(list.files(h("R/"), full.names = TRUE),
     source, echo = FALSE, verbose = FALSE)
country <- params$country

```

## Event Table
```{r event, message = FALSE, warning = FALSE}

event <- read_tsv(h("raw-eidith-data", "Event.tsv.gz"),  col_types = event_specs) %>%
  filter(Country == country) 

## for report-------

# map site locations 
leaflet(data = event) %>%
  addTiles() %>%
  addMarkers(lng = ~SiteLongitude, lat = ~SiteLatitude, label = ~SiteName)

# unique character values table
event_char <- event %>% select_if(is.character) %>% select(-EventName, -SiteName, -CommunityEngagementNotes, -Notes)
event_char_uniq <- apply(event_char, 2, unique)
map_df(event_char_uniq, ~paste(.x, collapse = "; ")) %>%
  mutate(EventDate = paste0("min = ", min(event$EventDate), "; max = ", max(event$EventDate))) %>%
  select(Country, EventDate, everything()) %>%
  t() %>%
  kable() %>%
  kable_styling()

# skimr summary
#event %>% skimr::skim() %>% skimr::kable()

## for excel-------

# check for NAs
na_index <- get_na(event, ignore_notes = TRUE)

# check for solo chars
solo_index <- get_solo_char(event)

# check for numeric outliers (not including lat/long)
outlier_index <- get_outlier(event)

# check that EventName matches SiteName and EventDate
event_index <- get_event_mismatch(event)

# check ID dups - to add

# for excel output
event.markup <- bind_rows(na_index,
                          solo_index, 
                          outlier_index,
                          event_index)

```
## Animal Table
```{r animal, message = FALSE, warning = FALSE}

animal <- read_tsv(h("raw-eidith-data", "Animal.tsv.gz"), col_types = animal_specs) %>%
  filter(Country == country)

## for report-------

# unique character values table
animal_char <- animal %>% select_if(is.character) %>% select(-Notes, -SiteName, -AnimalID, -EventName, -matches("Class|Order|Family|Genus|Species"))
animal_char_uniq <- apply(animal_char, 2, unique)
map_df(animal_char_uniq, ~paste(.x, collapse = "; ")) %>%
  t() %>%
  kable() %>%
  kable_styling()

## for excel-------

# check for solo chars
solo_index <- get_solo_char(animal)

# check for numeric outliers (not including lat/long)
outlier_index <- get_outlier(animal)

# check ID dups - to add

# check range vs species - to add

# for excel output
animal.markup <- bind_rows(solo_index,
                           outlier_index)

```

```{r write-xlsx-table, include = FALSE}

# Get highlighted workbook object
wb <- get_highlighted_wb(
  dfs = list(event, animal),
  tab.names = c("Event", "Animal"),
  markup.dfs = list(event.markup, animal.markup)
)

# Write the xlsx workbook for the country in question
saveWorkbook(
  wb,
  file = h("outputs", paste0(country, "-eidith-cleaning-workbook.xlsx")),
  overwrite = TRUE
)

```
