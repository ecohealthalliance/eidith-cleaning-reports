version: 2
jobs:
  build:
    working_directory: ~/main
    docker:
    - image: rocker/verse:latest
    steps:
    - run:
        command: |
          apt-get update && apt-get install -y --no-install-recommends libudunits2-dev
    - checkout
    - restore_cache:
        keys:
        - deps1-{{ .Branch }}-{{ checksum "DESCRIPTION" }}-{{ checksum ".circleci/config.yml"
          }}
        - deps1-{{ .Branch }}
        - deps1
    - run:
        command: |
          R -e "devtools::install_deps(dependencies=TRUE)"
    - save_cache:
        key: deps1-{{ .Branch }}-{{ checksum "DESCRIPTION" }}-{{ checksum ".circleci/config.yml"
          }}
        paths:
        - /usr/local/lib/R/site-library
    - run:
        command: |
          ./make.R
    - store_artifacts:
        path: /root/main/outputs/
        destination: artifacts
    - run:
        command: |
          ./deploy.sh
workflows:
  version: 2
  workflow:
    jobs:
    - build:
        filters:
          branches:
            only:
            - master
